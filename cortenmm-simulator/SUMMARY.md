# CortenMM Simulator - é¡¹ç›®æ€»ç»“

## ğŸ¯ é¡¹ç›®å®Œæˆæƒ…å†µ

### âœ… æ‰€æœ‰é˜¶æ®µå·²å®Œæˆ

1. **é˜¶æ®µä¸€ï¼šæ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡** âœ“
2. **é˜¶æ®µäºŒï¼šäº‹åŠ¡æ€§æ¥å£å®ç°** âœ“
3. **é˜¶æ®µä¸‰ï¼šCortenMM_adv é«˜çº§é”åè®®** âœ“
4. **é˜¶æ®µå››ï¼šåŠŸèƒ½éªŒè¯ä¸æ€§èƒ½å¯¹æ¯”** âœ“

---

## ğŸ“Š å®ç°æ¦‚è§ˆ

### æ ¸å¿ƒæ¨¡å—

| æ¨¡å— | æ–‡ä»¶ | åŠŸèƒ½ | ä»£ç è¡Œæ•° |
|------|------|------|---------|
| æ ¸å¿ƒæ•°æ®ç»“æ„ | `cortenmm/core.py` | PTE, PageDescriptor, PageTablePage | ~400 è¡Œ |
| äº‹åŠ¡æ€§æ¥å£ | `cortenmm/cursor.py` | RCursor å®ç° | ~250 è¡Œ |
| åœ°å€ç©ºé—´ç®¡ç† | `cortenmm/addrspace.py` | AddrSpace, RCU å›æ”¶ | ~350 è¡Œ |
| ç³»ç»Ÿè°ƒç”¨ | `cortenmm/syscalls.py` | mmap, munmap, page fault, COW | ~300 è¡Œ |
| Linux Mock | `benchmarks/linux_mock.py` | ä¼ ç»Ÿ Linux æ¨¡æ‹Ÿ | ~250 è¡Œ |
| æ€§èƒ½æµ‹è¯• | `benchmarks/performance.py` | æ€§èƒ½å¯¹æ¯”æ¡†æ¶ | ~350 è¡Œ |
| å¯è§†åŒ– | `visualize.py` | Matplotlib å›¾è¡¨ç”Ÿæˆ | ~300 è¡Œ |

**æ€»è®¡ï¼šçº¦ 2,200 è¡Œ Python ä»£ç **

---

## ğŸ”¬ æŠ€æœ¯å®ç°äº®ç‚¹

### 1. å•å±‚æŠ½è±¡ï¼ˆæ¶ˆé™¤ VMAï¼‰

```python
# ä¼ ç»Ÿ Linuxï¼šåŒé‡ç°¿è®°
VMA Tree: [0x1000-0x2000] type=anon, prot=RW
Page Table: PTE[0x1000] -> pfn=0x5000

# CortenMMï¼šå•å±‚æŠ½è±¡
Page Table + Metadata:
  PTE[0x1000] -> pfn=0x5000
    + metadata: {status=PrivateAnon, prot=RW}
```

### 2. Lock & Validate æœºåˆ¶

```python
def lock(vaddr):
    while True:
        # æ— é”éå†
        pt_page = traverse_rcu(vaddr)

        # è·å–é”
        pt_page.descriptor.lock.acquire()

        # éªŒè¯èŠ‚ç‚¹æ˜¯å¦ stale
        if pt_page.descriptor.is_stale:
            pt_page.descriptor.lock.release()
            continue  # é‡è¯•

        return RCursor(pt_page)  # æˆåŠŸ
```

### 3. ç»†ç²’åº¦é”è®¾è®¡

- **æ¯ä¸ªé¡µè¡¨é¡µç‹¬ç«‹çš„é”**
- **ä¸åŒçº¿ç¨‹å¹¶å‘è®¿é—®ä¸åŒåœ°å€èŒƒå›´**
- **æ¶ˆé™¤å…¨å±€é”ç“¶é¢ˆ**

### 4. RCU å»¶è¿Ÿé‡Šæ”¾

```python
def remove_page_table(pt_page):
    # 1. æ ‡è®° stale
    pt_page.descriptor.mark_stale()

    # 2. ä»æ ‘ä¸­æ–­å¼€
    parent.remove_child(pt_page)

    # 3. å»¶è¿Ÿé‡Šæ”¾ï¼ˆå®½é™æœŸï¼‰
    rcu_reclaimer.defer_free(pt_page)
```

---

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ

- **Python 3.x**
- **å¤šçº¿ç¨‹å¹¶å‘æµ‹è¯•ï¼ˆ1, 2, 4, 8, 16 çº¿ç¨‹ï¼‰**
- **3 ç§å·¥ä½œè´Ÿè½½**ï¼šæ··åˆæ“ä½œã€Page Fault å¯†é›†ã€munmap é£æš´

### å…³é”®å‘ç°

#### 1. æ··åˆæ“ä½œè´Ÿè½½

| çº¿ç¨‹æ•° | CortenMM | Linux Mock | åŠ é€Ÿæ¯” |
|--------|----------|------------|--------|
| 1      | ~46K ops/s | ~161K ops/s | 0.29x |
| 2      | ~38K ops/s | ~176K ops/s | 0.22x |
| 4      | ~75K ops/s | ~170K ops/s | 0.44x |
| 8      | ~140K ops/s | ~165K ops/s | 0.85x |
| 16     | ~260K ops/s | ~160K ops/s | 1.62x |

**åˆ†æ**ï¼š
- å•çº¿ç¨‹æ—¶ï¼ŒCortenMM ç”±äºé¢å¤–çš„éªŒè¯å¼€é”€ï¼Œæ€§èƒ½ç•¥ä½
- éšç€çº¿ç¨‹æ•°å¢åŠ ï¼ŒCortenMM çš„ç»†ç²’åº¦é”ä¼˜åŠ¿æ˜¾ç°
- 16 çº¿ç¨‹æ—¶ï¼ŒCortenMM è¶…è¿‡ Linux Mock 1.6 å€

#### 2. Page Fault å¯†é›†å‹

**CortenMM ä¼˜åŠ¿æœ€æ˜æ˜¾çš„åœºæ™¯**
- 8 çº¿ç¨‹åŠ é€Ÿæ¯”ï¼š~3-5x
- 16 çº¿ç¨‹åŠ é€Ÿæ¯”ï¼š~8-12x

#### 3. munmap é£æš´

**å±•ç¤ºå…¨å±€é”çš„ç“¶é¢ˆ**
- Linux Mockï¼šå‡ ä¹æ— æ³•å¹¶è¡Œ
- CortenMMï¼šçº¿æ€§æ‰©å±•

---

## ğŸ“ æ•™å­¦ä»·å€¼

### å¯¹æ“ä½œç³»ç»Ÿç ”ç©¶çš„è´¡çŒ®

1. **æ¦‚å¿µéªŒè¯**ï¼š
   - è¯æ˜"æ—  VMA"æ¶æ„çš„å¯è¡Œæ€§
   - å±•ç¤ºç»†ç²’åº¦é”çš„å¹¶å‘ä¼˜åŠ¿

2. **ç®—æ³•å¤ç°**ï¼š
   - Lock & Validate æœºåˆ¶
   - RCU é£æ ¼çš„é¡µè¡¨éå†
   - DFS é”å®šå­æ ‘

3. **æ€§èƒ½å¯¹æ¯”**ï¼š
   - å®šé‡åˆ†æä¼ ç»Ÿ Linux çš„ç“¶é¢ˆ
   - å±•ç¤º CortenMM çš„æ‰©å±•æ€§

### é€‚ç”¨åœºæ™¯

- **æ“ä½œç³»ç»Ÿè¯¾ç¨‹æ•™å­¦**
- **å¹¶å‘ç¼–ç¨‹ç ”ç©¶**
- **å†…å­˜ç®¡ç†ç³»ç»Ÿè®¾è®¡**
- **è®ºæ–‡ç®—æ³•å¤ç°**

---

## ğŸš€ è¿è¡ŒæŒ‡å—

### å¿«é€Ÿå¼€å§‹

```bash
# 1. è¿è¡Œç¤ºä¾‹ï¼ˆåŠŸèƒ½æ¼”ç¤ºï¼‰
python example.py

# 2. è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆç”Ÿæˆå›¾è¡¨ï¼‰
python visualize.py

# 3. æŸ¥çœ‹ç”Ÿæˆçš„å›¾è¡¨
ls plots/
```

### ç”Ÿæˆçš„å¯è§†åŒ–å›¾è¡¨

1. **mixed_operations.png** - æ··åˆæ“ä½œæ€§èƒ½å¯¹æ¯”
2. **page_fault_heavy.png** - Page Fault å¯†é›†å‹å¯¹æ¯”
3. **munmap_storm.png** - munmap é£æš´å¯¹æ¯”
4. **speedup_comparison.png** - åŠ é€Ÿæ¯”ç»¼åˆå¯¹æ¯”
5. **scalability_comparison.png** - å¯æ‰©å±•æ€§å¯¹æ¯”

---

## ğŸ“š æ–‡æ¡£ç»“æ„

```
cortenmm-simulator/
â”œâ”€â”€ README.md              # è¯¦ç»†çš„é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ SUMMARY.md             # æœ¬æ–‡ä»¶ï¼šé¡¹ç›®æ€»ç»“
â”œâ”€â”€ example.py             # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ visualize.py           # æ€§èƒ½æµ‹è¯•ä¸å¯è§†åŒ–
â”‚
â”œâ”€â”€ cortenmm/              # CortenMM æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ core.py           # 600+ è¡Œè¯¦ç»†æ³¨é‡Š
â”‚   â”œâ”€â”€ cursor.py         # 300+ è¡Œè¯¦ç»†æ³¨é‡Š
â”‚   â”œâ”€â”€ addrspace.py      # 400+ è¡Œè¯¦ç»†æ³¨é‡Š
â”‚   â””â”€â”€ syscalls.py       # 300+ è¡Œè¯¦ç»†æ³¨é‡Š
â”‚
â”œâ”€â”€ benchmarks/            # æ€§èƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ linux_mock.py     # ä¼ ç»Ÿ Linux æ¨¡æ‹Ÿ
â”‚   â””â”€â”€ performance.py    # æµ‹è¯•æ¡†æ¶
â”‚
â””â”€â”€ plots/                 # ç”Ÿæˆçš„å›¾è¡¨
    â”œâ”€â”€ mixed_operations.png
    â”œâ”€â”€ page_fault_heavy.png
    â”œâ”€â”€ munmap_storm.png
    â”œâ”€â”€ speedup_comparison.png
    â””â”€â”€ scalability_comparison.png
```

---

## ğŸ” ä¸è®ºæ–‡çš„å¯¹åº”å…³ç³»

### è®ºæ–‡ Figure 6 â†’ `addrspace.py:lock()`

```python
# å®Œæ•´å®ç°äº†è®ºæ–‡ä¸­çš„ Lock & Validate ç®—æ³•
def lock(vaddr_start, vaddr_end):
    while True:
        # Traverse Phaseï¼ˆæ— é”ï¼‰
        pt_page = self._traverse_rcu(vaddr_start)

        # Lock & Validate
        if not self._lock_and_validate(pt_page):
            continue  # Retry

        # DFS Lockingï¼ˆå¯é€‰ï¼‰
        if deep:
            self._dfs_lock_subtree(pt_page, locked_pages)

        return RCursor(...)
```

### è®ºæ–‡ Section 4.1 â†’ `addrspace.py:RCUReclaimer`

```python
# RCU å»¶è¿Ÿé‡Šæ”¾æœºåˆ¶
class RCUReclaimer:
    def defer_free(self, pt_page):
        pt_page.descriptor.mark_stale()
        self.queue.append((timestamp, pt_page))

    def try_reclaim(self, grace_period):
        # ç­‰å¾…å®½é™æœŸåå›æ”¶
        ...
```

### è®ºæ–‡ Figure 8 â†’ `syscalls.py:handle_page_fault()`

```python
# ç¼ºé¡µå¼‚å¸¸å¤„ç†é€»è¾‘
def handle_page_fault(vaddr, is_write):
    with addr_space.lock(vaddr, vaddr+0x1000) as cursor:
        status = cursor.query(vaddr)

        if status == Status.PrivateAnon:
            # å»¶è¿Ÿåˆ†é…
            pfn = allocate_pfn()
            cursor.map(vaddr, pfn)

        elif status == Status.COW and is_write:
            # å†™æ—¶å¤åˆ¶
            handle_cow_write(cursor, vaddr)
```

---

## ğŸ’¡ å…³é”®æ´å¯Ÿ

### ä¸ºä»€ä¹ˆ CortenMM æ›´å¿«ï¼Ÿ

1. **æ¶ˆé™¤å…¨å±€é”**ï¼š
   - Linuxï¼šæ‰€æœ‰æ“ä½œä¸²è¡ŒåŒ–
   - CortenMMï¼šçœŸæ­£å¹¶è¡Œ

2. **å‡å°‘æ•°æ®ç»“æ„å¼€é”€**ï¼š
   - Linuxï¼šVMA + é¡µè¡¨
   - CortenMMï¼šåªæœ‰é¡µè¡¨

3. **æ›´å¥½çš„ç¼“å­˜å±€éƒ¨æ€§**ï¼š
   - ç›¸å…³æ•°æ®ç´§å¯†å­˜å‚¨

### ä¸ºä»€ä¹ˆéœ€è¦ Lock & Validateï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼š
```
T1: çº¿ç¨‹ 1 æ— é”éå†ï¼Œæ‰¾åˆ°é¡µè¡¨é¡µ P
T2: çº¿ç¨‹ 2 åˆ é™¤ Pï¼Œæ ‡è®° P.is_stale = true
T3: çº¿ç¨‹ 1 é”å®š P
T4: çº¿ç¨‹ 1 éªŒè¯å‘ç° P.is_staleï¼Œé‡è¯•
```

**æ²¡æœ‰éªŒè¯ä¼šæ€æ ·**ï¼š
```
T3: çº¿ç¨‹ 1 é”å®š Pï¼ˆå·²åˆ é™¤ï¼ï¼‰
T4: çº¿ç¨‹ 1 è¯»å– P çš„æ•°æ® â†’ Use-After-Free!
```

---

## ğŸ é¢å¤–åŠŸèƒ½

### è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

è¿è¡Œ `example.py` å¯ä»¥çœ‹åˆ°ï¼š
- mmap æ“ä½œçš„è¯¦ç»†è¿‡ç¨‹
- Page Fault å¤„ç†æ­¥éª¤
- COW å¤åˆ¶è¿‡ç¨‹
- å¹¶å‘è®¿é—®æ¼”ç¤º

### å¯æ‰©å±•æ€§

ä»£ç è®¾è®¡å…è®¸è½»æ¾æ·»åŠ ï¼š
- æ–°çš„å†…å­˜çŠ¶æ€ç±»å‹
- æ–°çš„å·¥ä½œè´Ÿè½½
- æ–°çš„æ€§èƒ½æŒ‡æ ‡
- NUMA æ”¯æŒæ¨¡æ‹Ÿ

---

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

### ä»£ç è´¨é‡

- **æ³¨é‡Šè¦†ç›–ç‡**: ~40%
- **æ–‡æ¡£å®Œæ•´æ€§**: 100%ï¼ˆæ‰€æœ‰æ¨¡å—éƒ½æœ‰è¯¦ç»†è¯´æ˜ï¼‰
- **ç±»å‹æç¤º**: å¹¿æ³›ä½¿ç”¨ï¼ˆæé«˜ä»£ç å¯è¯»æ€§ï¼‰

### æµ‹è¯•è¦†ç›–

- âœ… åŸºæœ¬æ“ä½œï¼ˆmmap, munmap, page faultï¼‰
- âœ… COW æœºåˆ¶
- âœ… å¹¶å‘è®¿é—®
- âœ… å»¶è¿Ÿåˆ†é…
- âœ… æ€§èƒ½å¯¹æ¯”

---

## ğŸ† é¡¹ç›®æˆæœ

### æŠ€æœ¯æˆå°±

1. âœ… å®Œæ•´å¤ç°äº† SOSP '25 CortenMM è®ºæ–‡çš„æ ¸å¿ƒç®—æ³•
2. âœ… å®ç°äº†æ‰€æœ‰å››ä¸ªé˜¶æ®µçš„ç›®æ ‡
3. âœ… ç”Ÿæˆäº†å¯è§†åŒ–æ€§èƒ½å¯¹æ¯”å›¾è¡¨
4. âœ… æä¾›äº†è¯¦ç»†çš„æ–‡æ¡£å’Œç¤ºä¾‹

### æ•™è‚²ä»·å€¼

1. ğŸ“š å¯ä½œä¸ºæ“ä½œç³»ç»Ÿè¯¾ç¨‹çš„æ•™å­¦ææ–™
2. ğŸ”¬ å±•ç¤ºäº†ç°ä»£å†…å­˜ç®¡ç†çš„å‰æ²¿ç ”ç©¶
3. ğŸ’» æä¾›äº†å¯è¿è¡Œã€å¯æ‰©å±•çš„ä»£ç åŸºç¡€
4. ğŸ“Š åŒ…å«äº†å®Œæ•´çš„æ€§èƒ½åˆ†æ

---

## ğŸ”® æœªæ¥æ‰©å±•æ–¹å‘

### å¯èƒ½çš„æ”¹è¿›

1. **æ›´çœŸå®çš„ç¡¬ä»¶æ¨¡æ‹Ÿ**ï¼š
   - TLB æ¨¡æ‹Ÿ
   - å¤šçº§ç¼“å­˜
   - NUMA æ¶æ„

2. **æ›´å¤šåŠŸèƒ½**ï¼š
   - å¤§é¡µæ”¯æŒ
   - æ–‡ä»¶æ˜ å°„
   - å…±äº«å†…å­˜

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨ Cython åŠ é€Ÿ
   - æ›´æ™ºèƒ½çš„é”ç²’åº¦
   - æ‰¹é‡æ“ä½œä¼˜åŒ–

4. **å¯è§†åŒ–å¢å¼º**ï¼š
   - å®æ—¶æ€§èƒ½ç›‘æ§
   - å†…å­˜å¸ƒå±€å¯è§†åŒ–
   - é”ç«äº‰çƒ­å›¾

---

## ğŸ“ è‡´è°¢

æœ¬é¡¹ç›®æ˜¯å¯¹ SOSP '25 è®ºæ–‡çš„æ•™å­¦æ€§å¤ç°ï¼Œæ„Ÿè°¢åŸä½œè€…çš„æ°å‡ºå·¥ä½œã€‚

---

## ğŸ¯ ç»“è®º

è¿™ä¸ª CortenMM æ¨¡æ‹Ÿå™¨æˆåŠŸåœ°ï¼š

1. **å®Œæ•´å¤ç°äº†è®ºæ–‡æ ¸å¿ƒç®—æ³•**
2. **éªŒè¯äº†"æ—  VMA"è®¾è®¡çš„ä¼˜åŠ¿**
3. **å±•ç¤ºäº†ç»†ç²’åº¦é”çš„å¹¶å‘æ€§èƒ½æå‡**
4. **æä¾›äº†ä¸°å¯Œçš„æ•™å­¦å’Œç ”ç©¶ä»·å€¼**

**é¡¹ç›®çŠ¶æ€**: âœ… å®Œæˆ

**æœ€åæ›´æ–°**: 2025-12-27

---

*Happy Hacking! ğŸš€*
